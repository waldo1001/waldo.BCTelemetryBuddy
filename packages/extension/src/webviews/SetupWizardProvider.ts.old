import * as vscode from 'vscode';
import * as path from 'path';
import * as fs from 'fs';
import { exec } from 'child_process';
import { promisify } from 'util';
import { CHATMODE_DEFINITIONS } from '../chatmodeDefinitions';

const execAsync = promisify(exec);

export class SetupWizardProvider {
    public static readonly viewType = 'bcTelemetryBuddy.setupWizard';
    private _panel: vscode.WebviewPanel | undefined;
    private _disposables: vscode.Disposable[] = [];

    constructor(private readonly _extensionUri: vscode.Uri) { }

    public async show() {
        const column = vscode.window.activeTextEditor
            ? vscode.window.activeTextEditor.viewColumn
            : undefined;

        // If we already have a panel, show it and refresh settings
        if (this._panel) {
            this._panel.reveal(column);
            // Send current settings when revealing existing panel
            await this._sendCurrentSettings();
            return;
        }

        // Otherwise, create a new panel
        this._panel = vscode.window.createWebviewPanel(
            SetupWizardProvider.viewType,
            'BC Telemetry Buddy - Setup Wizard',
            column || vscode.ViewColumn.One,
            {
                enableScripts: true,
                retainContextWhenHidden: true,
                localResourceRoots: [
                    vscode.Uri.joinPath(this._extensionUri, 'dist'),
                    vscode.Uri.joinPath(this._extensionUri, 'src', 'webviews')
                ]
            }
        );

        this._panel.webview.html = this._getHtmlForWebview(this._panel.webview);

        // Handle messages from the webview
        this._panel.webview.onDidReceiveMessage(
            async (message) => {
                await this._handleMessage(message);
            },
            null,
            this._disposables
        );

        // Handle panel disposal
        this._panel.onDidDispose(() => this._onDispose(), null, this._disposables);
    }

    private async _handleMessage(message: any) {
        switch (message.type) {
            case 'validateWorkspace':
                await this._validateWorkspace();
                break;
            case 'validateAuth':
                await this._validateAuth(message.authFlow);
                break;
            case 'testConnection':
                await this._testConnection(message.settings);
                break;
            case 'saveSettings':
                await this._saveSettings(message.settings);
                break;
            case 'installChatmodes':
                await this._installChatmodes();
                break;
            case 'closeWizard':
                this._panel?.dispose();
                break;
            case 'openExternal':
                vscode.env.openExternal(vscode.Uri.parse(message.url));
                break;
            case 'requestCurrentSettings':
                await this._sendCurrentSettings();
                break;
        }
    }

    private async _validateWorkspace(): Promise<void> {
        const workspaceFolders = vscode.workspace.workspaceFolders;
        const hasWorkspace = workspaceFolders && workspaceFolders.length > 0;
        const isMultiRoot = workspaceFolders && workspaceFolders.length > 1;

        this._panel?.webview.postMessage({
            type: 'workspaceValidation',
            hasWorkspace,
            isMultiRoot,
            workspacePath: hasWorkspace ? workspaceFolders[0].uri.fsPath : null
        });
    }

    private async _validateAuth(authFlow: string): Promise<void> {
        let isValid = false;
        let message = '';

        try {
            if (authFlow === 'azure_cli') {
                // Check if Azure CLI is installed
                try {
                    await execAsync('az --version');

                    // Check if logged in and get account details
                    const { stdout } = await execAsync('az account show');
                    if (stdout.length > 0) {
                        isValid = true;

                        // Parse the JSON output to get account details
                        try {
                            const accountInfo = JSON.parse(stdout);
                            const user = accountInfo.user?.name || 'Unknown';
                            const subscription = accountInfo.name || 'Unknown';
                            const tenantId = accountInfo.tenantId || 'Unknown';
                            const tenantDisplayName = accountInfo.tenantDisplayName || accountInfo.tenantId || 'Unknown';

                            // Format with newlines for multi-line display
                            message = `Azure CLI authenticated\n\nUser: ${user}\nSubscription: ${subscription}\nTenant: ${tenantDisplayName}\nTenant ID: ${tenantId}`;
                        } catch (parseError) {
                            // If JSON parsing fails, just show basic message
                            message = 'Azure CLI authenticated';
                        }
                    } else {
                        message = 'Not logged in to Azure CLI';
                    }
                } catch (error: any) {
                    message = error.message.includes('az')
                        ? 'Azure CLI not installed'
                        : 'Not logged in to Azure CLI (run: az login)';
                }
            } else if (authFlow === 'device_code' || authFlow === 'client_credentials') {
                const config = vscode.workspace.getConfiguration('bctb.mcp');
                const tenantId = config.get<string>('tenantId');
                const clientId = config.get<string>('clientId');

                if (authFlow === 'client_credentials') {
                    const clientSecret = config.get<string>('auth.clientSecret');
                    isValid = !!(tenantId && clientId && clientSecret);
                    message = isValid
                        ? 'Client credentials configured'
                        : 'Missing tenant ID, client ID, or client secret';
                } else {
                    isValid = !!(tenantId && clientId);
                    message = isValid
                        ? 'Device code flow configured'
                        : 'Missing tenant ID or client ID';
                }
            }
        } catch (error: any) {
            message = error.message;
        }

        this._panel?.webview.postMessage({
            type: 'authValidation',
            isValid,
            message,
            authFlow
        });
    }

    private async _testConnection(settings: any): Promise<void> {
        // Use settings from the form, not from saved configuration
        // This allows testing before saving
        const appInsightsId = settings?.appInsightsId;
        const kustoUrl = settings?.kustoUrl;
        const authFlow = settings?.authFlow;

        let success = false;
        let message = '';
        let details = '';

        console.log('[SetupWizard] Testing connection with settings:', { appInsightsId, kustoUrl, authFlow });

        if (!appInsightsId || !kustoUrl) {
            message = '‚ùå Missing App Insights ID or Kusto URL';
            details = 'Please fill in all required fields before testing connection.';
        } else {
            try {
                // Validate authentication based on auth flow
                if (authFlow === 'azure_cli') {
                    const { exec } = await import('child_process');
                    const { promisify } = await import('util');
                    const execAsync = promisify(exec);

                    try {
                        const { stdout } = await execAsync('az account show');
                        const accountInfo = JSON.parse(stdout);
                        details = `‚úÖ Authenticated as: ${accountInfo.user.name}\n`;
                        details += `‚úÖ Subscription: ${accountInfo.name}\n`;
                        details += `‚úÖ App Insights ID: ${appInsightsId}\n`;
                        details += `‚úÖ Kusto Cluster: ${kustoUrl}\n`;
                        details += '\n‚ö†Ô∏è Note: Full query test requires MCP server to be running.';
                        success = true;
                        message = '‚úÖ Connection configuration is valid';
                    } catch (error: any) {
                        message = '‚ùå Azure CLI authentication failed';
                        details = 'Please run "az login" in your terminal first.';
                    }
                } else if (authFlow === 'device_code') {
                    if (!settings.clientId) {
                        message = '‚ùå Missing Client ID';
                        details = 'Client ID is required for device code flow.';
                    } else {
                        details = `‚úÖ Auth Flow: Device Code\n`;
                        details += `‚úÖ Client ID: ${settings.clientId}\n`;
                        details += `‚úÖ App Insights ID: ${appInsightsId}\n`;
                        details += `‚úÖ Kusto Cluster: ${kustoUrl}\n`;
                        details += '\n‚ö†Ô∏è Note: Full authentication test requires MCP server to be running.';
                        success = true;
                        message = '‚úÖ Configuration looks valid';
                    }
                } else if (authFlow === 'client_credentials') {
                    if (!settings.clientId || !settings.clientSecret) {
                        message = '‚ùå Missing Client ID or Client Secret';
                        details = 'Both Client ID and Client Secret are required for service principal authentication.';
                    } else {
                        details = `‚úÖ Auth Flow: Client Credentials\n`;
                        details += `‚úÖ Client ID: ${settings.clientId}\n`;
                        details += `‚úÖ App Insights ID: ${appInsightsId}\n`;
                        details += `‚úÖ Kusto Cluster: ${kustoUrl}\n`;
                        details += '\n‚ö†Ô∏è Note: Full authentication test requires MCP server to be running.';
                        success = true;
                        message = '‚úÖ Configuration looks valid';
                    }
                }
            } catch (error: any) {
                message = `‚ùå Connection test failed: ${error.message}`;
                details = error.stack || '';
            }
        }

        console.log('[SetupWizard] Connection test result:', { success, message });

        this._panel?.webview.postMessage({
            type: 'connectionTest',
            success,
            message,
            details
        });
    }

    private async _saveSettings(settings: any): Promise<void> {
        try {
            // Block multiroot workspaces
            const workspaceFolders = vscode.workspace.workspaceFolders;
            if (!workspaceFolders || workspaceFolders.length === 0) {
                throw new Error('No workspace folder open. Please open a folder first.');
            }
            if (workspaceFolders.length > 1) {
                throw new Error('Multi-root workspaces are not supported. Please open a single folder workspace.');
            }

            // ALWAYS save to WorkspaceFolder (single folder's .vscode/settings.json), NEVER to Workspace file
            // Get resource-scoped configuration for the workspace folder
            const folderUri = workspaceFolders[0].uri;
            const config = vscode.workspace.getConfiguration('bctb.mcp', folderUri);
            const target = vscode.ConfigurationTarget.WorkspaceFolder;

            // Save connection name and tenant settings
            if (settings.tenantName) {
                await config.update('connectionName', settings.tenantName, target);
            }
            if (settings.tenantId) {
                await config.update('tenantId', settings.tenantId, target);
            }

            // Save App Insights settings
            if (settings.appInsightsId) {
                await config.update('applicationInsights.appId', settings.appInsightsId, target);
            }

            // Save Kusto settings
            if (settings.kustoUrl) {
                await config.update('kusto.clusterUrl', settings.kustoUrl, target);
            }

            // Save auth settings
            if (settings.authFlow) {
                await config.update('authFlow', settings.authFlow, target);
            }
            if (settings.clientId) {
                await config.update('clientId', settings.clientId, target);
            }
            // Note: clientSecret is not saved to settings for security reasons
            // It would need to be stored in a secure credential store instead

            this._panel?.webview.postMessage({
                type: 'settingsSaved',
                success: true,
                message: 'Settings saved to folder configuration (.vscode/settings.json)'
            });

            // Prompt user to reload VS Code for settings to take effect
            const reloadAction = 'Reload Window';
            const result = await vscode.window.showInformationMessage(
                'BC Telemetry Buddy settings saved successfully! Please reload VS Code for the changes to take effect.',
                reloadAction
            );

            if (result === reloadAction) {
                await vscode.commands.executeCommand('workbench.action.reloadWindow');
            }
        } catch (error: any) {
            this._panel?.webview.postMessage({
                type: 'settingsSaved',
                success: false,
                message: error.message
            });

            vscode.window.showErrorMessage(`Failed to save settings: ${error.message}`);
        }
    }

    /**
     * Install multiple chatmodes to .github/chatmodes directory
     */
    private async _installChatmodes(): Promise<void> {
        try {
            const workspaceFolders = vscode.workspace.workspaceFolders;
            if (!workspaceFolders || workspaceFolders.length === 0) {
                throw new Error('No workspace folder open');
            }

            const workspacePath = workspaceFolders[0].uri.fsPath;
            const chatmodeDir = path.join(workspacePath, '.github', 'chatmodes');

            // Create .github/chatmodes directory if it doesn't exist
            if (!fs.existsSync(chatmodeDir)) {
                fs.mkdirSync(chatmodeDir, { recursive: true });
            }

            // Install all chatmodes
            let installedCount = 0;
            let existingCount = 0;
            const installedFiles: string[] = [];

            for (const chatmode of CHATMODE_DEFINITIONS) {
                const chatmodePath = path.join(chatmodeDir, chatmode.filename);
                if (fs.existsSync(chatmodePath)) {
                    existingCount++;
                } else {
                    fs.writeFileSync(chatmodePath, chatmode.content, 'utf-8');
                    installedCount++;
                    installedFiles.push(chatmode.title);
                }
            }

            // Send success message to webview
            this._panel?.webview.postMessage({
                type: 'chatmodeInstalled',
                success: true,
                alreadyExists: existingCount > 0,
                installedCount: installedCount,
                existingCount: existingCount,
                installedFiles: installedFiles.join(', '),
                message: installedCount > 0
                    ? `${installedCount} chatmode(s) installed, ${existingCount} already existed`
                    : 'All chatmodes already exist',
                path: chatmodeDir
            });
        } catch (error: any) {
            this._panel?.webview.postMessage({
                type: 'chatmodeInstalled',
                success: false,
                message: error.message
            });
        }
    }

    private async _sendCurrentSettings(): Promise<void> {
        // Get resource-scoped configuration (same as _saveSettings)
        const workspaceFolders = vscode.workspace.workspaceFolders;
        const folderUri = workspaceFolders && workspaceFolders.length > 0 ? workspaceFolders[0].uri : undefined;
        const config = vscode.workspace.getConfiguration('bctb.mcp', folderUri);

        const settings = {
            tenantName: config.get<string>('connectionName') || '',
            tenantId: config.get<string>('tenantId') || '',
            appInsightsId: config.get<string>('applicationInsights.appId') || '',
            kustoUrl: config.get<string>('kusto.clusterUrl') || '',
            authFlow: config.get<string>('authFlow') || 'azure_cli',
            clientId: config.get<string>('clientId') || '',
            clientSecret: '' // Not stored in settings for security
        };

        console.log('[SetupWizard] Sending current settings:', settings);

        this._panel?.webview.postMessage({
            type: 'currentSettings',
            settings
        });
    }

    private _getHtmlForWebview(webview: vscode.Webview): string {
        const nonce = getNonce();

        // Get logo as base64 (with fallback for tests)
        let logoDataUri = '';
        try {
            const logoPath = vscode.Uri.joinPath(this._extensionUri, 'images', 'waldo.png').fsPath;
            if (logoPath && fs.existsSync(logoPath)) {
                const logoBase64 = fs.readFileSync(logoPath).toString('base64');
                logoDataUri = `data:image/png;base64,${logoBase64}`;
            }
        } catch (error) {
            // Ignore errors (e.g., in test environment)
        }

        // For now, return inline HTML. In production, you might want to load from a file
        return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'none'; img-src data:; style-src ${webview.cspSource} 'unsafe-inline'; script-src 'nonce-${nonce}';">
    <title>BC Telemetry Buddy Setup</title>
    <style>
        body {
            font-family: var(--vscode-font-family);
            color: var(--vscode-foreground);
            background-color: var(--vscode-editor-background);
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .header-logo {
            text-align: center;
            margin-bottom: 20px;
        }
        .header-logo img {
            width: 80px;
            height: 80px;
        }
        h1 {
            color: var(--vscode-foreground);
            border-bottom: 2px solid var(--vscode-textLink-foreground);
            padding-bottom: 10px;
            text-align: center;
        }
        .wizard-steps {
            display: flex;
            justify-content: space-between;
            margin: 30px 0;
            padding: 0;
            list-style: none;
        }
        .wizard-step {
            flex: 1;
            text-align: center;
            position: relative;
            padding: 10px;
        }
        .wizard-step::after {
            content: '';
            position: absolute;
            top: 20px;
            right: -50%;
            width: 100%;
            height: 2px;
            background: var(--vscode-input-border);
            z-index: -1;
        }
        .wizard-step:last-child::after {
            display: none;
        }
        .step-number {
            display: inline-block;
            width: 40px;
            height: 40px;
            line-height: 40px;
            border-radius: 50%;
            background: var(--vscode-input-background);
            border: 2px solid var(--vscode-input-border);
            margin-bottom: 5px;
        }
        .wizard-step.active .step-number {
            background: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
            border-color: var(--vscode-button-background);
        }
        .wizard-step.completed .step-number {
            background: var(--vscode-terminal-ansiGreen);
            border-color: var(--vscode-terminal-ansiGreen);
        }
        .wizard-step.completed .step-number::before {
            content: '‚úì';
        }
        .step-content {
            display: none;
            margin: 30px 0;
            padding: 20px;
            background: var(--vscode-input-background);
            border-radius: 4px;
        }
        .step-content.active {
            display: block;
        }
        .form-group {
            margin: 20px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .help-text {
            font-size: 0.9em;
            color: var(--vscode-descriptionForeground);
            margin-top: 5px;
        }
        input, select {
            width: 100%;
            padding: 8px;
            background: var(--vscode-input-background);
            color: var(--vscode-input-foreground);
            border: 1px solid var(--vscode-input-border);
            border-radius: 2px;
            box-sizing: border-box;
        }
        input:focus, select:focus {
            outline: 1px solid var(--vscode-focusBorder);
        }
        textarea {
            width: 100%;
            min-height: 300px;
            padding: 12px;
            background: var(--vscode-input-background);
            color: var(--vscode-input-foreground);
            border: 2px solid var(--vscode-focusBorder);
            border-radius: 4px;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            resize: vertical;
            box-sizing: border-box;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
        }
        textarea:focus {
            outline: none;
            border-color: var(--vscode-inputOption-activeForeground);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.2), 0 0 0 1px var(--vscode-inputOption-activeForeground);
        }
        .config-examples {
            margin: 15px 0;
            padding: 15px;
            background: rgba(90, 90, 90, 0.15);
            border-left: 3px solid var(--vscode-textPreformat-foreground);
            border-radius: 4px;
        }
        .config-examples h4 {
            margin-top: 0;
            color: var(--vscode-descriptionForeground);
            font-size: 14px;
        }
        .examples-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 10px;
        }
        .example-column {
            display: flex;
            flex-direction: column;
        }
        .config-examples p {
            margin: 0 0 8px 0;
            color: var(--vscode-descriptionForeground);
            font-weight: 600;
        }
        .config-examples em {
            font-style: italic;
            opacity: 0.9;
            font-weight: normal;
        }
        .config-examples pre {
            margin: 0;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 3px;
            overflow-x: auto;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
            color: var(--vscode-editor-foreground);
            flex: 1;
        }
        button {
            padding: 8px 16px;
            background: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
            border: none;
            border-radius: 2px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background: var(--vscode-button-hoverBackground);
        }
        button.secondary {
            background: var(--vscode-button-secondaryBackground);
            color: var(--vscode-button-secondaryForeground);
        }
        button.secondary:hover {
            background: var(--vscode-button-secondaryHoverBackground);
        }
        .validation-status {
            display: inline-block;
            margin-left: 10px;
            padding: 8px 12px;
            border-radius: 2px;
            font-size: 0.9em;
            max-width: 500px;
            line-height: 1.5;
        }
        .validation-status.success {
            background: var(--vscode-terminal-ansiGreen);
            color: var(--vscode-editor-background);
        }
        .validation-status.error {
            background: var(--vscode-errorForeground);
            color: var(--vscode-editor-background);
        }
        .validation-status.warning {
            background: var(--vscode-editorWarning-foreground);
            color: var(--vscode-editor-background);
        }
        .button-group {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }
        .links {
            margin: 20px 0;
            padding: 15px;
            background: var(--vscode-textBlockQuote-background);
            border-left: 3px solid var(--vscode-textLink-foreground);
        }
        .links a {
            color: var(--vscode-textLink-foreground);
            text-decoration: none;
            display: block;
            margin: 5px 0;
        }
        .links a:hover {
            text-decoration: underline;
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            margin: 15px 0;
        }
        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        ${logoDataUri ? `<div class="header-logo">
            <img src="${logoDataUri}" alt="">
        </div>` : ''}
        <h1>üöÄ BC Telemetry Buddy Setup Wizard</h1>
        <p>Welcome! This wizard will help you configure BC Telemetry Buddy to connect to your Azure Data Explorer and Application Insights.</p>

        <ul class="wizard-steps">
            <li class="wizard-step active" data-step="1">
                <div class="step-number">1</div>
                <div>Welcome</div>
            </li>
            <li class="wizard-step" data-step="2">
                <div class="step-number">2</div>
                <div>Azure Config</div>
            </li>
            <li class="wizard-step" data-step="3">
                <div class="step-number">3</div>
                <div>Authentication</div>
            </li>
            <li class="wizard-step" data-step="4">
                <div class="step-number">4</div>
                <div>Test Connection</div>
            </li>
            <li class="wizard-step" data-step="5">
                <div class="step-number">5</div>
                <div>Complete</div>
            </li>
        </ul>

        <!-- Step 1: Welcome -->
        <div class="step-content active" data-step="1">
            <h2>Welcome to BC Telemetry Buddy! üëã</h2>
            <p>This setup wizard will guide you through configuring your connection to Azure Data Explorer (Kusto) and Application Insights for analyzing Business Central telemetry.</p>
            
            <!-- Multi-root workspace error -->
            <div id="multirootError" style="display: none; background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 15px; margin: 20px 0; border-radius: 4px;">
                <h3 style="margin-top: 0; color: #721c24;">‚ö†Ô∏è Multi-Root Workspaces Not Supported</h3>
                <p><strong>BC Telemetry Buddy does not support multi-root workspaces.</strong></p>
                <p>You currently have multiple folders open in this workspace. Settings must be saved to a single folder's <code>.vscode/settings.json</code> file, which is not possible with multi-root workspaces.</p>
                <p><strong>To proceed:</strong></p>
                <ol>
                    <li>Close this workspace</li>
                    <li>Open a single folder (File ‚Üí Open Folder)</li>
                    <li>Run the Setup Wizard again</li>
                </ol>
                <p>If you need different BC Telemetry configurations for different projects, open each project as a separate single-folder workspace.</p>
            </div>

            <div id="welcomeContent">
                <h3>What you'll need:</h3>
                <ul>
                    <li>‚úÖ <strong>Node.js</strong> installed on your system (<a href="#" data-url="https://nodejs.org/">Download Node.js</a>)</li>
                    <li>‚úÖ Azure subscription with access to Application Insights</li>
                    <li>‚úÖ Application Insights resource with BC telemetry data</li>
                    <li>‚úÖ Azure Data Explorer (Kusto) cluster URL and database</li>
                    <li>‚úÖ Authentication credentials (Azure CLI recommended)</li>
                </ul>

                <div class="links">
                    <h4>üìö Helpful Resources:</h4>
                    <a href="#" data-url="https://learn.microsoft.com/en-us/dynamics365/business-central/dev-itpro/administration/telemetry-overview">Business Central Telemetry Overview</a>
                    <a href="#" data-url="https://learn.microsoft.com/en-us/azure/azure-monitor/app/app-insights-overview">Application Insights Documentation</a>
                    <a href="#" data-url="https://learn.microsoft.com/en-us/azure/data-explorer/">Azure Data Explorer Documentation</a>
                </div>

                <div class="button-group">
                    <div></div>
                    <button id="nextButton" onclick="nextStep()">Next ‚Üí</button>
                </div>
            </div>
        </div>

        <!-- Step 2: Azure Configuration (JSON Editor) -->
        <div class="step-content" data-step="2">
            <h2>Azure Configuration</h2>
            <p>Configure your connection to Business Central telemetry using JSON format.</p>

            <div class="config-examples">
                <h4>üìñ Configuration Examples:</h4>
                <div class="examples-grid">
                    <div class="example-column">
                        <p><strong>Single Profile</strong> <em>(simple setup for one environment)</em></p>
                        <pre>{
  "$schema": "https://raw.githubusercontent.com/waldo1001/waldo.BCTelemetryBuddy/main/packages/mcp/config-schema.json",
  "connectionName": "My BC Environment",
  "authFlow": "azure_cli",
  "tenantId": "00000000-0000-0000-0000-000000000000",
  "applicationInsightsAppId": "00000000-0000-0000-0000-000000000000",
  "kustoClusterUrl": "https://ade.applicationinsights.io/subscriptions/YOUR-SUBSCRIPTION-ID",
  "cacheEnabled": true,
  "cacheTTLSeconds": 3600,
  "removePII": false,
  "workspacePath": "\${workspaceFolder}",
  "queriesFolder": "queries",
  "references": []
}</pre>
                    </div>
                    <div class="example-column">
                        <p><strong>Multiple Profiles</strong> <em>(for managing multiple customers/environments)</em></p>
                        <pre>{
  "defaultProfile": "customer-a-prod",
  "profiles": {
    "customer-a-prod": {
      "connectionName": "Customer A Production",
      "authFlow": "azure_cli",
      "tenantId": "00000000-0000-0000-0000-000000000000",
      "applicationInsightsAppId": "00000000-0000-0000-0000-000000000000",
      "kustoClusterUrl": "https://ade.applicationinsights.io/subscriptions/YOUR-SUBSCRIPTION-ID",
      "cacheEnabled": true,
      "cacheTTLSeconds": 3600,
      "removePII": false,
      "workspacePath": "\${workspaceFolder}",
      "queriesFolder": "queries",
      "references": []
    },
    "customer-b-prod": {
      "connectionName": "Customer B Production",
      "authFlow": "device_code",
      "tenantId": "11111111-1111-1111-1111-111111111111",
      "applicationInsightsAppId": "11111111-1111-1111-1111-111111111111",
      "kustoClusterUrl": "https://ade.applicationinsights.io/subscriptions/ANOTHER-SUBSCRIPTION-ID",
      "clientId": "22222222-2222-2222-2222-222222222222",
      "cacheEnabled": true,
      "cacheTTLSeconds": 3600,
      "removePII": false,
      "workspacePath": "\${workspaceFolder}",
      "queriesFolder": "queries",
      "references": []
    }
  }
}</pre>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="configEditor"><strong>Configuration JSON:</strong></label>
                <textarea id="configEditor" spellcheck="false" placeholder="Loading..."></textarea>
                <button class="secondary" style="margin-top: 10px;" onclick="validateConfigJson()">‚úì Validate JSON</button>
                <span id="jsonValidation" class="validation-status"></span>
            </div>

            <div class="links">
                <h4>üìö Need Help?</h4>
                <a href="#" data-url="https://portal.azure.com">Open Azure Portal</a>
                <a href="#" data-url="https://learn.microsoft.com/en-us/azure/azure-monitor/app/create-workspace-resource">Create Application Insights</a>
                <a href="#" data-url="https://learn.microsoft.com/en-us/dynamics365/business-central/dev-itpro/administration/telemetry-overview">BC Telemetry Setup Guide</a>
            </div>

            <div class="button-group">
                <button class="secondary" onclick="prevStep()">‚Üê Back</button>
                <button onclick="nextStep()">Next ‚Üí</button>
            </div>
        </div>

        <!-- Step 3: Authentication -->
        <div class="step-content" data-step="3">
            <h2>Authentication Setup</h2>
            <p>Choose how you want to authenticate with Azure.</p>

            <div class="form-group">
                <label for="authFlow">Authentication Method *</label>
                <select id="authFlow" onchange="updateAuthFields()">
                    <option value="azure_cli">Azure CLI (Recommended)</option>
                    <option value="device_code">Device Code Flow</option>
                    <option value="client_credentials">Client Credentials (Service Principal)</option>
                </select>
            </div>

            <div id="azureCliInfo" class="links">
                <h4>‚úÖ Azure CLI (Recommended)</h4>
                <p>Uses your existing Azure CLI login. Simplest and most secure option.</p>
                <ul>
                    <li>No need to manage credentials in settings</li>
                    <li>Uses your personal Azure account</li>
                    <li>Best for individual developers</li>
                </ul>
                <p><strong>Prerequisites:</strong></p>
                <ul>
                    <li>Install Azure CLI: <a href="#" data-url="https://learn.microsoft.com/en-us/cli/azure/install-azure-cli">Download here</a></li>
                    <li>Run: <code>az login</code> in terminal</li>
                </ul>
                <button onclick="validateAuth()">Validate Azure CLI</button>
                <span id="authValidation"></span>
            </div>

            <div id="deviceCodeInfo" class="links" style="display: none;">
                <h4>üì± Device Code Flow</h4>
                <p>Interactive authentication using a browser. Good for shared environments.</p>
                <div class="form-group">
                    <label for="deviceCodeClientId">Client ID *</label>
                    <input type="text" id="deviceCodeClientId" placeholder="Application (client) ID">
                    <div class="help-text">Register an app in Azure AD to get this ID</div>
                </div>
                <a href="#" data-url="https://learn.microsoft.com/en-us/azure/active-directory/develop/quickstart-register-app">How to register an Azure AD app</a>
            </div>

            <div id="clientCredentialsInfo" class="links" style="display: none;">
                <h4>üîê Client Credentials (Service Principal)</h4>
                <p>Automated authentication using a service principal. Best for CI/CD or shared scenarios.</p>
                <div class="form-group">
                    <label for="spClientId">Client ID *</label>
                    <input type="text" id="spClientId" placeholder="Application (client) ID">
                </div>
                <div class="form-group">
                    <label for="clientSecret">Client Secret *</label>
                    <input type="password" id="clientSecret" placeholder="Client secret value">
                    <div class="help-text">‚ö†Ô∏è Note: Stored in workspace settings (consider using environment variables for production)</div>
                </div>
                <a href="#" data-url="https://learn.microsoft.com/en-us/azure/active-directory/develop/howto-create-service-principal-portal">Create a Service Principal</a>
            </div>

            <div class="button-group">
                <button class="secondary" onclick="prevStep()">‚Üê Back</button>
                <button onclick="nextStep()">Next ‚Üí</button>
            </div>
        </div>

        <!-- Step 4: Test Connection -->
        <div class="step-content" data-step="4">
            <h2>Test Connection</h2>
            <p>Let's verify your configuration works!</p>

            <div class="links">
                <h4>üîç Connection Check</h4>
                <p>We'll test:</p>
                <ul>
                    <li>Authentication with Azure</li>
                    <li>Access to Application Insights</li>
                    <li>Connection to Kusto cluster</li>
                </ul>
            </div>

            <button onclick="testConnection()">üß™ Test Connection</button>
            <span id="connectionTest"></span>

            <div id="connectionResults" style="margin-top: 20px; display: none;">
                <h4>Test Results:</h4>
                <p id="connectionMessage"></p>
            </div>

            <div class="button-group">
                <button class="secondary" onclick="prevStep()">‚Üê Back</button>
                <button onclick="nextStep()">Next ‚Üí</button>
            </div>
        </div>

        <!-- Step 5: Complete -->
        <div class="step-content" data-step="5">
            <h2>üéâ Setup Complete!</h2>
            <p>Your BC Telemetry Buddy is ready to use.</p>

            <!-- Warning for multiroot with folder-level settings -->
            <div id="multirootWarning" class="links" style="display: none; margin-bottom: 20px; padding: 15px; background: #3a2d00; border-radius: 4px; border-left: 4px solid var(--vscode-editorWarning-foreground);">
                <h4>‚ö†Ô∏è Multiroot Workspace Detected</h4>
                <p>Your workspace has multiple folders, and some have folder-level BC Telemetry Buddy settings that <strong>will be ignored</strong>.</p>
                <p id="multirootWarningDetails"></p>
                <p style="margin-top: 10px;"><strong>Solution:</strong> To use per-project settings, open each project as a separate single-root workspace. In multiroot workspaces, only workspace file settings are used.</p>
            </div>

            <div class="links">
                <h4>‚úÖ Configuration Summary</h4>
                <p id="settingsLocationMessage">Your settings will be saved to <code>.vscode/settings.json</code> in your workspace.</p>
                <p><em>For optional features (queries folder, cache TTL, CodeLens), see the README.</em></p>
            </div>

            <div class="links" style="margin-top: 20px; padding: 15px; background: #2d2d30; border-radius: 8px; border-left: 4px solid #007acc;">
                <h4>ü§ñ GitHub Copilot Chatmodes (Recommended)</h4>
                <p>Install BC Telemetry Buddy chatmodes to get expert assistance in Copilot Chat.</p>
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <input type="checkbox" id="installChatmode" checked style="width: 18px; height: 18px; cursor: pointer;">
                    <span>Install chatmodes (2 specialized modes) to <code>.github/chatmodes/</code></span>
                </label>
                <p style="margin-top: 10px; font-size: 0.9em; color: #cccccc;">
                    ‚ÑπÔ∏è After installation, type <code>@workspace</code> in Copilot Chat, then select the chatmode from the dropdown to activate expert modes.
                </p>
                <span id="chatmodeStatus" style="margin-top: 10px; display: block;"></span>
            </div>

            <button onclick="saveSettings()">üíæ Save Configuration</button>
            <span id="saveStatus"></span>

            <div class="links" style="margin-top: 30px;">
                <h4>üöÄ Next Steps:</h4>
                <ul>
                    <li>Chat with GitHub Copilot and ask about your BC telemetry</li>
                    <li>Example: "@workspace Show me all errors from BC in the last 24 hours"</li>
                    <li>Or use Command Palette: "BC Telemetry Buddy: Run KQL Query"</li>
                    <li>Create and save your own KQL queries in <code>.kql</code> files</li>
                </ul>
                <p><strong>üí° Tip:</strong> The MCP server will automatically start when you chat with Copilot!</p>
                <a href="#" data-url="https://github.com/waldo1001/waldo.BCTelemetryBuddy/blob/main/README.md">üìñ Read the README</a>
            </div>

            <div class="button-group">
                <button class="secondary" onclick="prevStep()">‚Üê Back</button>
                <button onclick="closeWizard()">Finish ‚úì</button>
            </div>
        </div>
    </div>

    <script nonce="${nonce}">
        const vscode = acquireVsCodeApi();
        let currentStep = 1;
        const totalSteps = 5;

        // State variables
        let isMultiRoot = false;
        let hasFolderLevelSettings = false;
        let foldersWithSettings = [];

        // Request current settings and validate workspace on load
        window.addEventListener('load', () => {
            vscode.postMessage({ type: 'validateWorkspace' });
            vscode.postMessage({ type: 'requestCurrentSettings' });
        });

        // Handle messages from extension
        window.addEventListener('message', event => {
            const message = event.data;
            switch (message.type) {
                case 'currentSettings':
                    populateSettings(message.settings);
                    break;
                case 'authValidation':
                    showAuthValidation(message);
                    break;
                case 'connectionTest':
                    showConnectionTest(message);
                    break;
                case 'settingsSaved':
                    showSaveStatus(message);
                    break;
                case 'chatmodeInstalled':
                    showChatmodeStatus(message);
                    break;
                case 'workspaceValidation':
                    handleWorkspaceValidation(message);
                    break;
            }
        });

        function handleWorkspaceValidation(message) {
            const isMultiRoot = message.isMultiRoot || false;
            const errorDiv = document.getElementById('multirootError');
            const welcomeContent = document.getElementById('welcomeContent');
            const nextButton = document.getElementById('nextButton');

            if (isMultiRoot) {
                // Show error, hide welcome content, disable Next button
                if (errorDiv) errorDiv.style.display = 'block';
                if (welcomeContent) welcomeContent.style.display = 'none';
                if (nextButton) nextButton.disabled = true;
            } else {
                // Hide error, show welcome content, enable Next button
                if (errorDiv) errorDiv.style.display = 'none';
                if (welcomeContent) welcomeContent.style.display = 'block';
                if (nextButton) nextButton.disabled = false;
            }
        }

        function populateSettings(settings) {
            console.log('[SetupWizard] Populating settings:', settings);
            
            // Populate JSON editor
            const configEditor = document.getElementById('configEditor');
            if (configEditor) {
                // Convert settings object to JSON format expected by .bctb-config.json
                const config = {
                    "$schema": "https://raw.githubusercontent.com/waldo1001/waldo.BCTelemetryBuddy/main/packages/mcp/config-schema.json",
                    connectionName: settings.tenantName || 'My BC Environment',
                    authFlow: settings.authFlow || 'azure_cli',
                    tenantId: settings.tenantId || '00000000-0000-0000-0000-000000000000',
                    applicationInsightsAppId: settings.appInsightsId || '00000000-0000-0000-0000-000000000000',
                    kustoClusterUrl: settings.kustoUrl || 'https://ade.applicationinsights.io/subscriptions/YOUR-SUBSCRIPTION-ID',
                    cacheEnabled: true,
                    cacheTTLSeconds: 3600,
                    removePII: false,
                    workspacePath: "\${workspaceFolder}",
                    queriesFolder: "queries",
                    references: []
                };
                
                if (settings.clientId) {
                    config.clientId = settings.clientId;
                }
                
                configEditor.value = JSON.stringify(config, null, 2);
            }
            
            // Also populate auth flow dropdown for step 3
            const authFlowEl = document.getElementById('authFlow');
            if (authFlowEl) authFlowEl.value = settings.authFlow || 'azure_cli';
            
            const deviceCodeClientIdEl = document.getElementById('deviceCodeClientId');
            const spClientIdEl = document.getElementById('spClientId');
            const clientSecretEl = document.getElementById('clientSecret');
            
            if (deviceCodeClientIdEl) deviceCodeClientIdEl.value = settings.clientId || '';
            if (spClientIdEl) spClientIdEl.value = settings.clientId || '';
            if (clientSecretEl) clientSecretEl.value = settings.clientSecret || '';
            
            console.log('[SetupWizard] Settings populated successfully');
            updateAuthFields();
        }

        function validateConfigJson() {
            const configEditor = document.getElementById('configEditor');
            const validationSpan = document.getElementById('jsonValidation');
            
            if (!configEditor || !validationSpan) return;
            
            const configJson = configEditor.value.trim();
            if (!configJson) {
                validationSpan.className = 'validation-status error';
                validationSpan.textContent = '‚úó Configuration is empty';
                return;
            }
            
            try {
                JSON.parse(configJson);
                validationSpan.className = 'validation-status success';
                validationSpan.textContent = '‚úì JSON is valid';
            } catch (error) {
                validationSpan.className = 'validation-status error';
                validationSpan.textContent = \`‚úó Invalid JSON: \${error.message}\`;
            }
        }

        function nextStep() {
            console.log('[nextStep] Current:', currentStep, 'Total:', totalSteps);
            if (currentStep < totalSteps) {
                goToStep(currentStep + 1);
            }
        }

        function prevStep() {
            console.log('[prevStep] Current:', currentStep);
            if (currentStep > 1) {
                goToStep(currentStep - 1);
            }
        }

        function goToStep(step) {
            console.log('[goToStep] Moving from', currentStep, 'to', step);
            
            // Hide current step
            var currentContent = document.querySelector('.step-content[data-step="' + currentStep + '"]');
            var currentStepElem = document.querySelector('.wizard-step[data-step="' + currentStep + '"]');
            
            console.log('[goToStep] Current content element:', currentContent);
            console.log('[goToStep] Current step element:', currentStepElem);
            
            if (currentContent) currentContent.classList.remove('active');
            if (currentStepElem) {
                currentStepElem.classList.remove('active');
                currentStepElem.classList.add('completed');
            }

            // Show new step
            currentStep = step;
            var newContent = document.querySelector('.step-content[data-step="' + currentStep + '"]');
            var newStepElem = document.querySelector('.wizard-step[data-step="' + currentStep + '"]');
            
            console.log('[goToStep] New content element:', newContent);
            console.log('[goToStep] New step element:', newStepElem);
            
            if (newContent) newContent.classList.add('active');
            if (newStepElem) newStepElem.classList.add('active');

            // Trigger workspace validation when entering Step 5 (Complete)
            if (currentStep === 5) {
                vscode.postMessage({ type: 'validateWorkspace' });
            }
        }

        function updateAuthFields() {
            const authFlow = document.getElementById('authFlow').value;
            document.getElementById('azureCliInfo').style.display = authFlow === 'azure_cli' ? 'block' : 'none';
            document.getElementById('deviceCodeInfo').style.display = authFlow === 'device_code' ? 'block' : 'none';
            document.getElementById('clientCredentialsInfo').style.display = authFlow === 'client_credentials' ? 'block' : 'none';
        }

        function validateAuth() {
            const authFlow = document.getElementById('authFlow').value;
            vscode.postMessage({ type: 'validateAuth', authFlow });
        }

        function showAuthValidation(message) {
            const span = document.getElementById('authValidation');
            span.className = 'validation-status ' + (message.isValid ? 'success' : 'error');
            span.innerHTML = message.message.replace(/\\n/g, '<br>');
        }

        function testConnection() {
            // Collect current form values to test connection
            const authFlow = document.getElementById('authFlow').value;
            const settings = {
                tenantName: document.getElementById('tenantName').value,
                tenantId: document.getElementById('tenantId').value,
                appInsightsId: document.getElementById('appInsightsId').value,
                kustoUrl: document.getElementById('kustoUrl').value,
                authFlow: authFlow,
                clientId: authFlow === 'device_code' 
                    ? document.getElementById('deviceCodeClientId').value 
                    : document.getElementById('spClientId').value,
                clientSecret: authFlow === 'client_credentials' 
                    ? document.getElementById('clientSecret').value 
                    : ''
            };
            
            vscode.postMessage({ type: 'testConnection', settings });
        }

        function showConnectionTest(message) {
            const span = document.getElementById('connectionTest');
            span.className = \`validation-status \${message.success ? 'success' : 'error'}\`;
            span.textContent = message.message;

            const results = document.getElementById('connectionResults');
            results.style.display = 'block';
            const messageEl = document.getElementById('connectionMessage');
            
            // Display message with details if available
            if (message.details) {
                messageEl.innerHTML = '<strong>' + message.message + '</strong><br><br>' + 
                                     message.details.replace(/\\n/g, '<br>');
            } else {
                messageEl.textContent = message.message;
            }
        }

        function saveSettings() {
            const authFlow = document.getElementById('authFlow').value;
            const settings = {
                tenantName: document.getElementById('tenantName').value,
                tenantId: document.getElementById('tenantId').value,
                appInsightsId: document.getElementById('appInsightsId').value,
                kustoUrl: document.getElementById('kustoUrl').value,
                authFlow: authFlow,
                clientId: authFlow === 'device_code' 
                    ? document.getElementById('deviceCodeClientId').value 
                    : document.getElementById('spClientId').value,
                clientSecret: authFlow === 'client_credentials' 
                    ? document.getElementById('clientSecret').value 
                    : ''
            };

            vscode.postMessage({ type: 'saveSettings', settings });

            // Install chatmodes if checkbox is checked
            const installChatmode = document.getElementById('installChatmode').checked;
            if (installChatmode) {
                const chatmodeStatus = document.getElementById('chatmodeStatus');
                chatmodeStatus.className = 'validation-status';
                chatmodeStatus.textContent = '‚è≥ Installing chatmodes...';
                vscode.postMessage({ type: 'installChatmodes' });
            }
        }

        function showSaveStatus(message) {
            const span = document.getElementById('saveStatus');
            span.className = \`validation-status \${message.success ? 'success' : 'error'}\`;
            span.textContent = message.message;
        }

        function showChatmodeStatus(message) {
            const span = document.getElementById('chatmodeStatus');
            if (message.success) {
                if (message.installedCount > 0) {
                    span.className = 'validation-status success';
                    span.textContent = \`‚úÖ \${message.installedCount} chatmode(s) installed successfully! Reload VS Code to activate.\`;
                } else if (message.alreadyExists) {
                    span.className = 'validation-status success';
                    span.textContent = '‚úÖ All chatmodes already installed';
                } else {
                    span.className = 'validation-status success';
                    span.textContent = '‚úÖ Chatmodes installed successfully! Reload VS Code to activate.';
                }
            } else {
                span.className = 'validation-status error';
                span.textContent = \`‚ùå Failed to install chatmodes: \${message.message}\`;
            }
        }

        function closeWizard() {
            // Close the wizard panel
            vscode.postMessage({ type: 'closeWizard' });
        }

        // Handle external link clicks
        document.addEventListener('click', (e) => {
            const target = e.target;
            if (target.tagName === 'A' && target.dataset.url) {
                e.preventDefault();
                vscode.postMessage({ type: 'openExternal', url: target.dataset.url });
            }
        });
    </script>
</body>
</html>`;
    }

    private _onDispose() {
        this._panel = undefined;

        // Clean up disposables
        while (this._disposables.length) {
            const disposable = this._disposables.pop();
            if (disposable) {
                disposable.dispose();
            }
        }
    }

    public dispose() {
        this._onDispose();
    }
}

function getNonce() {
    let text = '';
    const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    for (let i = 0; i < 32; i++) {
        text += possible.charAt(Math.floor(Math.random() * possible.length));
    }
    return text;
}
